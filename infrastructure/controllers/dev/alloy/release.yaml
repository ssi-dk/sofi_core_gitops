apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alloy
spec:
  chart:
    spec:
      chart: alloy
      version: "1.2.1"
      sourceRef:
        kind: HelmRepository
        name: grafana
  interval: 1h0m0s
  values:
    alloy:
      configMap:
        create: true
        name: alloy-config
        content: |-
          logging {
            level = "info"
            format = "logfmt"
          }
          loki.write "default" {
            endpoint {
              url = "http://loki.sofi.svc.cluster.local:3100/loki/api/v1/push"
            }
          }
          // local.file_match discovers files on the local filesystem using glob patterns and the doublestar library. It returns an array of file paths.
          local.file_match "node_logs" {
            path_targets = [{
                // Monitor syslog to scrape node-logs
                __path__  = "/var/log/syslog",
                job       = "node/syslog",
                node_name = sys.env("HOSTNAME"),
                cluster   = dev,
            }]
          }

          // loki.source.file reads log entries from files and forwards them to other loki.* components.
          // You can specify multiple loki.source.file components by giving them different labels.
          loki.source.file "node_logs" {
            targets    = local.file_match.node_logs.targets
            forward_to = [loki.write.default.receiver]
          }
          